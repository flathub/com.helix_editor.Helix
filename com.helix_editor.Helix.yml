app-id: com.helix_editor.Helix

runtime: org.freedesktop.Sdk
runtime-version: '23.08'
sdk: org.freedesktop.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.rust-stable

command: hx-wrapper

rename-desktop-file: Helix.desktop
rename-icon: helix
rename-appdata-file: Helix.appdata.xml

finish-args:
  # Filesystem acess
  - --filesystem=host
  - --filesystem=/tmp
  - --filesystem=/var/tmp
  # Clipboard access
  - --socket=wayland
  - --socket=fallback-x11
  - --share=ipc
  # Ability to fetch grammars. Some language servers might also need network
  - --share=network
  # Ability to flatpak-spawn language servers on host
  - --talk-name=org.freedesktop.Flatpak

modules:
  - name: wl-clipboard
    buildsystem: meson
    config-opts:
      - -Dzshcompletiondir=no
      - -Dfishcompletiondir=no
    sources:
      - type: archive
        url: https://github.com/bugaevc/wl-clipboard/archive/v2.2.1.tar.gz
        sha256: 6eb8081207fb5581d1d82c4bcd9587205a31a3d47bea3ebeb7f41aa1143783eb
        x-checker-data:
          type: anitya
          project-id: 49082
          url-template: https://github.com/bugaevc/wl-clipboard/archive/v$version.tar.gz
    cleanup:
      - /share/man
      - /share/bash-completion

  - name: xclip
    sources:
      - type: archive
        url: https://github.com/astrand/xclip/archive/0.13.tar.gz
        sha256: ca5b8804e3c910a66423a882d79bf3c9450b875ac8528791fb60ec9de667f758
    cleanup:
      - /share/man
      - /bin/xclip-*file
    modules:
      - name: libXmu
        config-opts:
          - --disable-static
          - --disable-docs
        sources:
          - type: archive
            url: https://www.x.org/releases/individual/lib/libXmu-1.1.3.tar.bz2
            sha256: 9c343225e7c3dc0904f2122b562278da5fed639b1b5e880d25111561bac5b731
        cleanup:
          - /include
          - /lib/pkgconfig
          - '*.la'

  - name: hx
    buildsystem: simple
    build-commands:
      - cargo --offline fetch --manifest-path Cargo.toml
      - HELIX_DISABLE_AUTO_GRAMMAR_BUILD=1 cargo --offline build --profile=opt
      - install -Dm755 ./target/opt/hx -t /app/lib/helix

      - mkdir -p /app/lib/helix/runtime
      - cp -r ./runtime/themes /app/lib/helix/runtime/themes
      - cp -r ./runtime/queries /app/lib/helix/runtime/queries
      - cp ./runtime/tutor /app/lib/helix/runtime/tutor

      - install -Dm644 ./contrib/Helix.desktop -t /app/share/applications
      - install -Dm644 ./contrib/helix.png -t /app/share/icons/hicolor/256x256/apps
      - install -Dm644 ./contrib/Helix.appdata.xml -t /app/share/metainfo

      - desktop-file-edit --set-key=Exec --set-value=hx-wrapper /app/share/applications/Helix.desktop
    sources:
      - type: archive
        url: https://github.com/helix-editor/helix/archive/refs/tags/24.03.tar.gz
        sha256: 2b6c1e4909e77c97d7acfbdc653c0790f7aa2d5f68684e2105e1b0563506da4f
      - type: patch
        path: appdata_file.patch
      # sources for cargo dependencies generated by https://github.com/flatpak/flatpak-builder-tools/tree/master/cargo
      - cargo-sources.json
    build-options:
      append-path: /usr/lib/sdk/rust-stable/bin
      env:
        CARGO_HOME: /run/build/hx/cargo

  - grammars/grammars.yml

  - name: wrapper
    buildsystem: meson
    sources:
      - type: dir
        path: wrapper
      - type: file
        path: HELIX_FIRST_RUN.md
    config-opts:
      - -Deditor_binary=/app/lib/helix/hx
      - -Dprogram_name=hx-wrapper
      - -Deditor_title=Helix
      - -Dflagfile_prefix=flatpak-helix
      - -Dfirst_run_template=./HELIX_FIRST_RUN.md
      - -Ddefault_loglevel=0
